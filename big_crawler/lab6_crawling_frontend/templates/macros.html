{# DEFINITION OF OFTEN USED MACROS, THAT CAN BE IMPORTED #}
{# use "{% import "macros.html" as macros %}" for import #}

{% macro dashboards_sidebar(cur_date, calendar) %}
<h6 class="sidebar-heading">Dashboards</h6>
<ul class="nav flex-column">
  <li class="nav-item">
      <a class="cat-link" href={{ url_for("dashboard") }}>
        <span class="fas fa-home"></span>
        Current
      </a>
  </li>
  <div>
  {#- create a namespace for the last_month variable,
      otherwise this won't work as expected -#}
  {%- set ns = namespace(last_month=None) %}
  {%- for entry in calendar %}
    {%- set expand = cur_date.date|isomonth == entry.date|isomonth %}
    {%- if ns.last_month != entry.date|isomonth %}
    </div>
    <li class="nav-item">
      <!-- put the badges first, since chrome sometimes treats float-right weirdly -->
      <span class="badge indicator float-right">
        <span class="data-span" data-var="open">{{ entry.n_open }}</span>
        <span>/</span>
        <span class="data-span" data-var="waiting">{{ entry.n_waiting }}</span>
        <span>/</span>
        <span class="data-span" data-var="finished">{{ entry.n_finished }}</span>
      </span>
      <a class="cat-link {{ 'active' if expand }}" data-toggle="collapse"
        href={{ "#" + entry.date|isomonth }} aria-expanded={{ expand }}>
        {%- if expand -%}
          <span class="fas fa-caret-down"></span>
        {%- else -%}
          <span class="fas fa-caret-right"></span>
        {%- endif -%}
        {{- entry.date|displaymonth -}}
      </a>
    </li>
    <div class="category collapse {{ 'show' if expand }}" id={{ entry.date|isomonth }}>
    {%- endif %}
    {% set active = cur_date.date|isodate == entry.date|isodate %}
    <li class="nav-item">
      <!-- put the badges first, since chrome sometimes treats float-right weirdly -->
      <span class="badge indicator float-right">
        <span class="data-span" data-var="open">{{ cur_date.n_open if active else entry.n_open }}</span>
        <span>/</span>
        <span class="data-span" data-var="waiting">{{ cur_date.n_waiting if active else entry.n_waiting }}</span>
        <span>/</span>
        <span class="data-span" data-var="finished">{{ cur_date.n_finished if active else entry.n_finished }}</span>
      </span>
      <a class="nav-link p-0 {{ 'active' if active }}" href={{ url_for("dashboard", dbdate=entry.date|isodate ) }}>{{ entry.date|engldate }}</a>
    </li>
  {%- set ns.last_month = entry.date|isomonth -%}
  {%- endfor -%}
</ul>
{% endmacro %}

{% macro document_entry(doc) %}
<div class="document-title text-left">
  <div class="overflow-fade">
    <a href={{ url_for( "document", doc_id=doc.id) }} target="_blank" title="{{ doc.document }}" data-var="title">{{ doc.document }}</a>
  </div>
  <div class="btn-group mt-1">
    <a class="btn btn-outline-secondary btn-block" href={{ doc.source }} target="_blank" title="Show source document">
      <span class="fas fa-{{ 'home' if doc.source|lower == 'inhouse' else 'link' }}"></span>
      <span>Source: {{ doc.source|domainextract }}</span>
    </a>
    <a class="btn btn-outline-secondary" href={{ url_for( "document_download", doc_id=doc.id) }} target="_blank" title="Show saved document">
      <span class="fas fa-file-pdf"></span>
    </a>
  </div>
</div>
{% endmacro %}

{% macro progress_bar(number, max) %}
<div class="progress">
  {% set width = (number|abs / max) * 100|int %}
  <div class="progress-bar progress-bar-striped bg-{{ 'success' if number > 0 else 'danger' }}" role="progressbar" 
      aria-valuenow="{{ number|abs }}" aria-valuemin="0" aria-valuemax="{{ max }}"
      style="width: {{ width if width > 0 else 1 }}%;">
    {{ number|sign }} {{ number|abs|bignumber }}
  </div>
</div>
{% endmacro %}

{% macro change_entry(doc) %}
{% set max_lines = (doc.change.lines_added, doc.change.lines_removed)|max %}
<a class="click-wrapper" href="{{ url_for('document_diff', doc_id=doc.id) }}">
  {{ progress_bar(doc.change.lines_added, max_lines) }}
  {{ progress_bar(-doc.change.lines_removed, max_lines) }}
</a>
{% endmacro %}

{% macro quantity_entry(doc) %}
  <div class="quantity" data-var="wordcount">
    <span>{{ doc.quantity.words|bignumber }}</span>
    <span>words</span>
  </div>
  <div class="quantity" data-var="linecount">
    <span>{{ doc.quantity.lines|bignumber }}</span>
    <span>lines</span>
  </div>
  {% endmacro %}

  {% macro back_button(doc_id) %}
  <a class="btn btn-secondary float-right" id="btnReturn" href="{{ url_for('dashboard', dbdate=doc_id) }}">
  <span class="fas fa-long-arrow-alt-left"></span>
</a>
{% endmacro %}

{% macro word_cloud(word_freqs) %}
<div class="word-cloud card mt-2" id="wordCloud">
  <h5 class="card-header">Word cloud</h5>
  <div class="card-body lead">
  {% for word, freq in word_freqs.items() %}
    <span class="word size-{{ freq|from(0, 1)|to(1, 5) }}">
      {{ word }}
    </span>
  {% endfor %}
  </div>
</div>
{% endmacro %}

{% macro include_pdf(doc_id) %}
<object class="pdf-container" data="{{ url_for('document_download', doc_id=doc_id) }}"
        type="application/pdf" width="100%" height="100%" data-base-url="{{ url_for('document_download', doc_id='0') }}">
  <h6>PDF-Preview</h6>
  This browser does not support PDF-Embedding. Please download the PDF to view it:
  <a href="{{ url_for('document_download', doc_id=doc_id) }}">
    <span class="fas fa-file-pdf"></span> Download PDF
  </a>
</object>
{% endmacro %}

{% macro diff_lines(lines) %}
  {%- for line in lines -%}
  <div class="diff-line {{ 'highlight' if line.mark }} {{ 'crossout' if line.num == ':' }}">
    <span class="diff-number">{{- line.num -}} </span>
    <span class="diff-text">
      {{- line.line -}}
    </span>
  </div>
  {%- endfor -%}
{% endmacro %}

{% macro diff_version(version, block_num=1) %}
<div class="card my-1">
  <h6 class="card-header p-1">
    <button class="btn btn-link m-0 p-1" data-toggle="collapse" data-target=".collapse.block-{{ block_num }}">
      Lines #{{ version[0]["num"] }} to #{{ version[-1]["num"] }}:
    </button>
  </h6>
  <div class="collapse block-{{ block_num }} show">
    <div class="card-body">
    {{- diff_lines(version) -}}
    </div>
  </div>
</div>
{% endmacro %}

{% macro diff_view(diff_texts) %}
{% for block in diff_texts %}
<div class="row">
  <div class="col-lg-6 col-md-12">
    <div class="diff diff-left">
    {{ diff_version(block['+'], loop.index) }}
    </div>
  </div>
  <div class="col-lg-6 col-md-12">
    <div class="diff diff-right">
    {{ diff_version(block['-'], loop.index) }}
    </div>
  </div>
</div>
{% endfor %}
{% endmacro %}
